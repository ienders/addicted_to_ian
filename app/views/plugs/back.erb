<script type = "text/javascript">
  function PlugThumb(thumbs, obj) {
    this.obj = obj
    this.i = parseInt(obj.attr('rel'));
    this.col = this.i % thumbs.row_length;
    this.row = (this.i - (this.i % thumbs.row_length)) / thumbs.row_length;
    
    this.original_height = parseInt(this.obj.css('height')) - 1;
    this.original_width = parseInt(this.obj.css('width')) - 1;
    
  }

  PlugThumb.prototype.freeze = function() {
    this.obj.css('position', 'absolute');
    this.obj.css('top', (this.original_height * this.row) + 'px');
    this.obj.css('left', (this.col * this.original_width) + 'px');
  };

  function PlugThumbs(size, options) {
    options = jQuery.extend({ row_length: 4, visible_rows: 3, wrapper_class: 'thumb_holder', plug_id_prefix: 'plug_' }, options)
    
    this.row_length = options.row_length;
    this.visible_rows = options.visible_rows
    this.wrapper_class = options.wrapper_class
    this.plug_id_prefix = options.plug_id_prefix
    
    this.obj = jQuery('.' + wrapper_class);
    this.size = this.obj.size();
    
    this.thumbs = new Array(this.size);
    self = this
    this.obj.each(function() {
      this.thumbs[$(this).attr('rel')] = new PlugThumb(self, jQuery(this));
    });
    
    this.thumbs_visible = true;
  }
  
  PlugThumbs.prototype.randomFade = function(except) {
    
  };
  
  PlugThumbs.prototype.doneHiding = function() {
    this.obj.find('img').attr('src', '/images/thumb_large_ibm.jpg');
    this.obj.animate({ left: 17, top: 27}, 2000, function() {
      obj.find('img').animate({ height: 300, width: 500 }, 'medium', function() {
        $('.plug').fadeIn('slow', function() {
          sifr_plugs();
          $('.plug_text').fadeIn('slow', function() {
            $('.plug_link_holder').fadeIn('slow', function() {
              $('.close').fadeIn('slow');
            });
          });
        });
      });
    });
  };
  
  PlugThumbs.prototype.init = function() {
    self = this
    this.obj.click(function(e) {
      if (!self.thumbs_visible) {
        return;
      }
      
      self.thumbs_visible = false;
      
      var i = parseInt($(this).attr('rel'));
      jQuery.each(self.thumbs), function(i, thumb) {
        thumb.freeze();
      });

      var arr = new Array();
      for (var k = 0; k < self.size; k++) {
        if (i != k) {
          arr.push(k);
        }
      }
      arr.sort(function() { return (Math.round(Math.random()) - 0.5) })
      var index = 0;

      (function randomHide(e) {
        var j = parseInt(e.attr('rel'));
        e.fadeOut(100, function() {
          index++;
          if (index < arr.length) {
            randomHide($('#' + self.plug_id_prefix + arr[index]));
          } else {
            self.thumbs[i].slideOpen();
          }
        });
      })($('#' + self.plug_id_prefix + arr[index]));
      e.preventDefault();
    });
    return self;
  };
  
  $(function() {
    var thumbs = new PlugThumbs().init();
    
    $('.thumb_holder').hover(
      function() {
        if (!thumbs_visible) {
          return;
        }
        $(this).find('.plug_title_overlay').slideToggle('fast', function() {
          $(this).find('span').fadeIn('fast');
        });
      },
      function() {
        if (!thumbs_visible) {
          $(this).find('span').hide();
          $(this).find('.plug_title_overlay').hide();
          return;
        }
        $(this).find('span').fadeOut('fast', function() {
          console.log($(this));
          $(this).parents('.plug_title_overlay').slideToggle('fast');
        });
      }
    );
    
    $('.close').click(function(e) {
      $(this).parents('.plug').fadeOut('slow');
      
      e.preventDefault();
    });
    
  });
  
  function doneHiding(obj) {

  }
</script>